{% extends "base.html" %}
{% block content %}
<h3 class="mb-3">Pedidos</h3>

<div class="pedidos-board">
  <div class="row g-4">
    <!-- PENDIENTES -->
    <div class="col-md-4">
      <h5 class="text-center mb-3">Pendientes</h5>
      <div class="kanban-column" id="PENDIENTE">
        {% for p in pedidos_pendientes %}
          {% set fecha_estado = '-' %}
          {% if p.estado == 'PENDIENTE' and p.pendiente_at %}
            {% set fecha_estado = p.pendiente_at.strftime('%d/%m/%Y') %}
          {% elif p.estado == 'EN_CURSO' and p.en_curso_at %}
            {% set fecha_estado = p.en_curso_at.strftime('%d/%m/%Y') %}
          {% elif p.estado == 'FINALIZADO' and p.finalizado_at %}
            {% set fecha_estado = p.finalizado_at.strftime('%d/%m/%Y') %}
          {% endif %}

          {% set deb = (p.total or 0) - (p.monto_sena or 0) %}
          {% set deb_clase = 'text-danger' if deb > 0 else 'text-success' %}

          <div class="pedido-card pedido-nueva" data-id="{{ p.id }}">
            <div class="pedido-header">
              <div class="pedido-title">{{ (p.cliente or '-')|upper }}</div>
              <div class="pedido-fecha">{{ fecha_estado }}</div>

              <button type="button" class="pedido-toggle" aria-label="Desplegar/ocultar">
                <i class="bi bi-chevron-down"></i>
              </button>
            </div>

            <div class="pedido-body pedido-collapsed">
              <div class="pedido-label">Pedido: <span class="text-muted">#{{ p.id }}</span></div>

              <div class="pedido-items">
                {% for it in p.items %}
                  <div class="pedido-item-line">{{ it.descripcion }}</div>
                {% else %}
                  <div class="pedido-item-line text-muted">Sin items</div>
                {% endfor %}
              </div>

              <div class="pedido-debe">
                <div class="pedido-debe-label">Debe:</div>
                <div class="pedido-debe-valor {{ deb_clase }}">
                  ${{ '%.2f'|format(deb) }}
                </div>
              </div>

              <button type="button" class="btn btn-primary btn-vermas w-100 mt-2" data-id="{{ p.id }}">
                Ver Más
              </button>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- EN CURSO -->
    <div class="col-md-4">
      <h5 class="text-center mb-3">En Curso</h5>
      <div class="kanban-column" id="EN_CURSO">
        {% for p in pedidos_en_curso %}
          {% set fecha_estado = '-' %}
          {% if p.estado == 'PENDIENTE' and p.pendiente_at %}
            {% set fecha_estado = p.pendiente_at.strftime('%d/%m/%Y') %}
          {% elif p.estado == 'EN_CURSO' and p.en_curso_at %}
            {% set fecha_estado = p.en_curso_at.strftime('%d/%m/%Y') %}
          {% elif p.estado == 'FINALIZADO' and p.finalizado_at %}
            {% set fecha_estado = p.finalizado_at.strftime('%d/%m/%Y') %}
          {% endif %}

          {% set deb = (p.total or 0) - (p.monto_sena or 0) %}
          {% set deb_clase = 'text-danger' if deb > 0 else 'text-success' %}

          <div class="pedido-card pedido-nueva" data-id="{{ p.id }}">
            <div class="pedido-header">
              <div class="pedido-title">{{ (p.cliente or '-')|upper }}</div>
              <div class="pedido-fecha">{{ fecha_estado }}</div>

              <button type="button" class="pedido-toggle" aria-label="Desplegar/ocultar">
                <i class="bi bi-chevron-down"></i>
              </button>
            </div>

            <div class="pedido-body pedido-collapsed">
              <div class="pedido-label">Pedido: <span class="text-muted">#{{ p.id }}</span></div>

              <div class="pedido-items">
                {% for it in p.items %}
                  <div class="pedido-item-line">{{ it.descripcion }}</div>
                {% else %}
                  <div class="pedido-item-line text-muted">Sin items</div>
                {% endfor %}
              </div>

              <div class="pedido-debe">
                <div class="pedido-debe-label">Debe:</div>
                <div class="pedido-debe-valor {{ deb_clase }}">
                  ${{ '%.2f'|format(deb) }}
                </div>
              </div>

              <button type="button" class="btn btn-primary btn-vermas w-100 mt-2" data-id="{{ p.id }}">
                Ver Más
              </button>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- FINALIZADOS -->
    <div class="col-md-4">
      <h5 class="text-center mb-3">Finalizados</h5>
      <div class="kanban-column" id="FINALIZADO">
        {% for p in pedidos_finalizados %}
          {% set fecha_estado = '-' %}
          {% if p.estado == 'PENDIENTE' and p.pendiente_at %}
            {% set fecha_estado = p.pendiente_at.strftime('%d/%m/%Y') %}
          {% elif p.estado == 'EN_CURSO' and p.en_curso_at %}
            {% set fecha_estado = p.en_curso_at.strftime('%d/%m/%Y') %}
          {% elif p.estado == 'FINALIZADO' and p.finalizado_at %}
            {% set fecha_estado = p.finalizado_at.strftime('%d/%m/%Y') %}
          {% endif %}

          {% set deb = (p.total or 0) - (p.monto_sena or 0) %}
          {% set deb_clase = 'text-danger' if deb > 0 else 'text-success' %}

          <div class="pedido-card pedido-nueva" data-id="{{ p.id }}">
            <div class="pedido-header">
              <div class="pedido-title">{{ (p.cliente or '-')|upper }}</div>
              <div class="pedido-fecha">{{ fecha_estado }}</div>

              <button type="button" class="pedido-toggle" aria-label="Desplegar/ocultar">
                <i class="bi bi-chevron-down"></i>
              </button>
            </div>

            <div class="pedido-body pedido-collapsed">
              <div class="pedido-label">Pedido: <span class="text-muted">#{{ p.id }}</span></div>

              <div class="pedido-items">
                {% for it in p.items %}
                  <div class="pedido-item-line">{{ it.descripcion }}</div>
                {% else %}
                  <div class="pedido-item-line text-muted">Sin items</div>
                {% endfor %}
              </div>

              <div class="pedido-debe">
                <div class="pedido-debe-label">Debe:</div>
                <div class="pedido-debe-valor {{ deb_clase }}">
                  ${{ '%.2f'|format(deb) }}
                </div>
              </div>

              <button type="button" class="btn btn-primary btn-vermas w-100 mt-2" data-id="{{ p.id }}">
                Ver Más
              </button>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- Modal Ver Más -->
<div class="modal fade" id="modalPedido" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-custom">
    <div class="modal-content pedido-modal">

      <div class="modal-header pedido-modal-header">
        <div class="mp-header-wrap w-100">
          <div class="mp-header-title" id="mp-cliente">Cliente</div>
          <div class="mp-header-sub" id="mp-orden">Nro de Orden: #-</div>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body pedido-modal-body">

        <div class="pedido-datos">
          <div class="dato"><strong>Domicilio:</strong> <span id="mp-domicilio"></span></div>
          <div class="dato"><strong>Teléfono:</strong> <span id="mp-telefono"></span></div>
          <div class="dato"><strong>E-mail:</strong> <span id="mp-email"></span></div>
          <div class="dato"><strong>Observaciones:</strong> <span id="mp-obs"></span></div>
        </div>

        <hr class="pedido-sep">

        <div class="pedido-detalle">
          <div class="pedido-box">
            <div class="seccion-titulo pedido-titulo">
              <span>Detalle del Pedido</span>
              <span id="mp-estado-badge" class="badge d-none"></span>
            </div>

            <div id="mp-items" class="pedido-items"></div>

            <div class="pedido-total">
              <span><strong>Total:</strong></span>
              <span id="mp-total" class="fw-bold"></span>
            </div>
          </div>
        </div>

        <div class="forma-pago-box">
          <div class="seccion-titulo">Forma de Pago</div>
          <div class="dato"><strong>Forma:</strong> <span id="mp-forma"></span></div>
          <div class="dato"><strong>Seña:</strong> <span id="mp-sena"></span></div>
          <div class="dato"><strong>Debe:</strong> <span id="mp-debe"></span></div>

          <div class="mp-addpago-wrap">
            <button type="button" class="btn btn-success" id="mp-add-pago">
              <span class="mp-plus">+</span> Agregar Pago
            </button>
          </div>
        </div>

        <div class="pedido-acciones">
          <a class="btn btn-outline-secondary" id="mp-imprimir" target="_blank">
            <i class="bi bi-printer"></i> Imprimir
          </a>

          <button type="button" class="btn btn-outline-secondary text-danger" id="mp-eliminar">
            <i class="bi bi-trash"></i> Eliminar
          </button>
        </div>

      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const columns = document.querySelectorAll(".kanban-column");

  function refreshEmptyColumns(){
    columns.forEach(col => {
      const hasCard = !!col.querySelector(".pedido-nueva");
      col.classList.toggle("is-empty", !hasCard);
    });
  }

  refreshEmptyColumns();

  columns.forEach(col => {
    new Sortable(col, {
      group: "pedidos",
      animation: 150,
      draggable: ".pedido-nueva",
      handle: ".pedido-header",
      filter: "button, .btn, a, input, select, textarea",
      preventOnFilter: true,
      chosenClass: "sortable-chosen",
      dragClass: "sortable-drag",

      onEnd: async (evt) => {
        const card = evt.item;
        const pedidoId = card.dataset.id;
        const newEstado = evt.to.id;

        refreshEmptyColumns();
        if (evt.from === evt.to) return;

        try {
          const res = await fetch(`/pedidos/mover/${pedidoId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ estado: newEstado })
          });

          if (!res.ok) {
            evt.from.appendChild(card);
            refreshEmptyColumns();
            alert("Error al mover el pedido");
          }
        } catch (e) {
          evt.from.appendChild(card);
          refreshEmptyColumns();
          alert("Error al mover el pedido");
        }
      },

      onAdd: refreshEmptyColumns,
      onRemove: refreshEmptyColumns
    });
  });

  document.addEventListener("click", (e) => {
    if (e.target.closest("input, select, textarea, a, button")) return;

    const card = e.target.closest(".pedido-nueva");
    if (!card) return;

    const body = card.querySelector(".pedido-body");
    if (!body) return;

    body.classList.toggle("pedido-collapsed");
    card.classList.toggle("is-open");
  });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const modalEl = document.getElementById("modalPedido");
  const modal = new bootstrap.Modal(modalEl);

  let pedidoActualId = null;

  async function abrirDetallePedido(id) {
    pedidoActualId = id;

    // ===== RESET UI (antes de mostrar) =====
    document.getElementById("mp-orden").textContent = `Nro de Orden: #${id}`;
    document.getElementById("mp-cliente").textContent = "Cargando...";
    document.getElementById("mp-domicilio").textContent = "-";
    document.getElementById("mp-telefono").textContent = "-";
    document.getElementById("mp-email").textContent = "-";
    document.getElementById("mp-obs").textContent = "-";
    document.getElementById("mp-items").innerHTML = "<div class='text-muted'>Cargando...</div>";
    document.getElementById("mp-total").textContent = "-";
    document.getElementById("mp-forma").textContent = "-";
    document.getElementById("mp-sena").textContent = "-";

    const elDebe = document.getElementById("mp-debe");
    elDebe.textContent = "-";
    elDebe.classList.remove("debe-ok", "debe-bad");

    // Badge oculto mientras carga
    const badge = document.getElementById("mp-estado-badge");
    badge.textContent = "";
    badge.className = "badge d-none";

    // Link imprimir
    document.getElementById("mp-imprimir").setAttribute("href", `/pedidos/${id}/pdf`);

    // Mostrar modal ya (con loading)
    modal.show();

    // ===== FETCH =====
    let p;
    try {
      const res = await fetch(`/api/pedidos/${id}`);
      if (!res.ok) throw new Error("HTTP " + res.status);
      p = await res.json();
    } catch (err) {
      document.getElementById("mp-items").innerHTML =
        "<div class='text-danger'>Error cargando el pedido</div>";
      return;
    }

    // ===== ESTADO BADGE =====
    badge.className = "badge"; // reset total
    badge.classList.remove("d-none");

    if (p.estado === "PENDIENTE") {
      badge.textContent = "Pendiente";
      badge.classList.add("mp-badge-pendiente");
    } else if (p.estado === "EN_CURSO") {
      badge.textContent = "En Curso";
      badge.classList.add("mp-badge-curso");
    } else if (p.estado === "FINALIZADO") {
      badge.textContent = "Finalizado";
      badge.classList.add("mp-badge-finalizado");
    } else {
      badge.textContent = "";
      badge.classList.add("d-none");
    }

    // ===== DATOS CLIENTE =====
    document.getElementById("mp-cliente").textContent = (p.cliente || "-").toString();
    document.getElementById("mp-domicilio").textContent = p.direccion || "-";
    document.getElementById("mp-telefono").textContent = p.telefono || "-";
    document.getElementById("mp-email").textContent = p.email || "-";
    document.getElementById("mp-obs").textContent = p.observaciones || "-";
    document.getElementById("mp-orden").textContent = `Nro de Orden: #${p.id ?? id}`;

    // ===== FORMA PAGO =====
    document.getElementById("mp-forma").textContent = p.forma_pago || "-";

    const senaTxt = (p.monto_sena !== null && p.monto_sena !== undefined)
      ? `$${Number(p.monto_sena).toLocaleString('es-AR')}`
      : "-";
    document.getElementById("mp-sena").textContent = senaTxt;

    const totalTxt = `$${Number(p.total || 0).toLocaleString('es-AR')}`;
    document.getElementById("mp-total").textContent = totalTxt;

    // ===== DEBE =====
    const debe = Number(p.total || 0) - Number(p.monto_sena || 0);

    elDebe.classList.remove("debe-ok", "debe-bad");
    if (debe > 0) {
      elDebe.textContent = `$${debe.toLocaleString('es-AR')}`;
      elDebe.classList.add("debe-bad");
    } else {
      elDebe.textContent = "No hay Deudas";
      elDebe.classList.add("debe-ok");
    }

    // ===== ITEMS =====
    const cont = document.getElementById("mp-items");
    cont.innerHTML = "";

    if (!p.items || !p.items.length) {
      cont.innerHTML = "<div class='text-muted'>Sin items</div>";
    } else {
      p.items.forEach(it => {
        const row = document.createElement("div");
        row.className = "pedido-item-row";

        const subtotal = `$${Number(it.subtotal || 0).toLocaleString('es-AR')}`;
        row.innerHTML = `
          <div class="pedido-item-desc">${it.descripcion || "-"}</div>
          <div class="pedido-item-dots"></div>
          <div class="pedido-item-sub">${subtotal}</div>
        `;
        cont.appendChild(row);
      });
    }
  }

  // Abrir modal desde Ver Más
  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".btn-vermas");
    if (!btn) return;

    e.preventDefault();
    e.stopPropagation();

    const id = btn.dataset.id;
    if (!id) return;

    abrirDetallePedido(id);
  });

  // Eliminar
  document.getElementById("mp-eliminar").addEventListener("click", async () => {
    if (!pedidoActualId) return;
    if (!confirm("¿Eliminar pedido?")) return;

    const res = await fetch(`/pedidos/eliminar/${pedidoActualId}`, { method: "POST" });
    if (!res.ok) {
      alert("No se pudo eliminar.");
      return;
    }

    modal.hide();
    window.location.reload();
  });

  // Agregar pago (placeholder)
  document.getElementById("mp-add-pago").addEventListener("click", () => {
    alert("Agregar Pago lo hacemos después ✅");
  });

  // Fix freeze al cerrar (backdrop zombie)
  modalEl.addEventListener("hidden.bs.modal", function () {
    if (!document.querySelector(".modal.show")) {
      document.body.classList.remove("modal-open");
      document.body.style.removeProperty("padding-right");
      document.querySelectorAll(".modal-backdrop").forEach(b => b.remove());
    }
  });
});
</script>
{% endblock %}