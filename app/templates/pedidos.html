{% extends "base.html" %}
{% block content %}
<h3 class="mb-3">Pedidos</h3>

<div class="pedidos-board">
  <div class="row g-4">
    <!-- PENDIENTES -->
    <div class="col-md-4">
      <h5 class="text-center mb-3">Pendientes</h5>
      <div class="kanban-column" id="PENDIENTE">
        {% for p in pedidos_pendientes %}
          {% set fecha_estado = '-' %}
          {% if p.estado == 'PENDIENTE' and p.pendiente_at %}
            {% set fecha_estado = p.pendiente_at.strftime('%d/%m/%Y') %}
          {% elif p.estado == 'EN_CURSO' and p.en_curso_at %}
            {% set fecha_estado = p.en_curso_at.strftime('%d/%m/%Y') %}
          {% elif p.estado == 'FINALIZADO' and p.finalizado_at %}
            {% set fecha_estado = p.finalizado_at.strftime('%d/%m/%Y') %}
          {% endif %}

          {% set deb = (p.total or 0) - (p.monto_sena or 0) %}
          {% set deb_clase = 'text-danger' if deb > 0 else 'text-success' %}

          <div class="pedido-card pedido-nueva" draggable="true" data-id="{{ p.id }}">
            <div class="pedido-header">
              <div class="pedido-title">{{ (p.cliente or '-')|upper }}</div>
              <div class="pedido-fecha">{{ fecha_estado }}</div>

              <button type="button" class="pedido-toggle" aria-label="Desplegar/ocultar">
                <i class="bi bi-chevron-down"></i>
              </button>
            </div>

            <div class="pedido-body pedido-collapsed">
              <div class="pedido-label">Pedido: <span class="text-muted">#{{ p.id }}</span></div>

              <div class="pedido-items">
                {% for it in p.items %}
                  <div class="pedido-item-line">{{ it.descripcion }}</div>
                {% else %}
                  <div class="pedido-item-line text-muted">Sin items</div>
                {% endfor %}
              </div>

              <div class="pedido-debe">
                <div class="pedido-debe-label">Debe:</div>
                <div class="pedido-debe-valor {{ deb_clase }}">
                  ${{ '%.2f'|format(deb) }}
                </div>
              </div>

              <button type="button" class="btn btn-primary btn-vermas w-100 mt-2" data-id="{{ p.id }}">
                Ver Más
              </button>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- EN CURSO -->
    <div class="col-md-4">
      <h5 class="text-center mb-3">En Curso</h5>
      <div class="kanban-column" id="EN_CURSO">
        {% for p in pedidos_en_curso %}
          {% set fecha_estado = '-' %}
          {% if p.estado == 'PENDIENTE' and p.pendiente_at %}
            {% set fecha_estado = p.pendiente_at.strftime('%d/%m/%Y') %}
          {% elif p.estado == 'EN_CURSO' and p.en_curso_at %}
            {% set fecha_estado = p.en_curso_at.strftime('%d/%m/%Y') %}
          {% elif p.estado == 'FINALIZADO' and p.finalizado_at %}
            {% set fecha_estado = p.finalizado_at.strftime('%d/%m/%Y') %}
          {% endif %}

          {% set deb = (p.total or 0) - (p.monto_sena or 0) %}
          {% set deb_clase = 'text-danger' if deb > 0 else 'text-success' %}

          <div class="pedido-card pedido-nueva" draggable="true" data-id="{{ p.id }}">
            <div class="pedido-header">
              <div class="pedido-title">{{ (p.cliente or '-')|upper }}</div>
              <div class="pedido-fecha">{{ fecha_estado }}</div>

              <button type="button" class="pedido-toggle" aria-label="Desplegar/ocultar">
                <i class="bi bi-chevron-down"></i>
              </button>
            </div>

            <div class="pedido-body pedido-collapsed">
              <div class="pedido-label">Pedido: <span class="text-muted">#{{ p.id }}</span></div>

              <div class="pedido-items">
                {% for it in p.items %}
                  <div class="pedido-item-line">{{ it.descripcion }}</div>
                {% else %}
                  <div class="pedido-item-line text-muted">Sin items</div>
                {% endfor %}
              </div>

              <div class="pedido-debe">
                <div class="pedido-debe-label">Debe:</div>
                <div class="pedido-debe-valor {{ deb_clase }}">
                  ${{ '%.2f'|format(deb) }}
                </div>
              </div>

              <button type="button" class="btn btn-primary btn-vermas w-100 mt-2" data-id="{{ p.id }}">
                Ver Más
              </button>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- FINALIZADOS -->
    <div class="col-md-4">
      <h5 class="text-center mb-3">Finalizados</h5>
      <div class="kanban-column" id="FINALIZADO">
        {% for p in pedidos_finalizados %}
          {% set fecha_estado = '-' %}
          {% if p.estado == 'PENDIENTE' and p.pendiente_at %}
            {% set fecha_estado = p.pendiente_at.strftime('%d/%m/%Y') %}
          {% elif p.estado == 'EN_CURSO' and p.en_curso_at %}
            {% set fecha_estado = p.en_curso_at.strftime('%d/%m/%Y') %}
          {% elif p.estado == 'FINALIZADO' and p.finalizado_at %}
            {% set fecha_estado = p.finalizado_at.strftime('%d/%m/%Y') %}
          {% endif %}

          {% set deb = (p.total or 0) - (p.monto_sena or 0) %}
          {% set deb_clase = 'text-danger' if deb > 0 else 'text-success' %}

          <div class="pedido-card pedido-nueva" draggable="true" data-id="{{ p.id }}">
            <div class="pedido-header">
              <div class="pedido-title">{{ (p.cliente or '-')|upper }}</div>
              <div class="pedido-fecha">{{ fecha_estado }}</div>

              <button type="button" class="pedido-toggle" aria-label="Desplegar/ocultar">
                <i class="bi bi-chevron-down"></i>
              </button>
            </div>

            <div class="pedido-body pedido-collapsed">
              <div class="pedido-label">Pedido: <span class="text-muted">#{{ p.id }}</span></div>

              <div class="pedido-items">
                {% for it in p.items %}
                  <div class="pedido-item-line">{{ it.descripcion }}</div>
                {% else %}
                  <div class="pedido-item-line text-muted">Sin items</div>
                {% endfor %}
              </div>

              <div class="pedido-debe">
                <div class="pedido-debe-label">Debe:</div>
                <div class="pedido-debe-valor {{ deb_clase }}">
                  ${{ '%.2f'|format(deb) }}
                </div>
              </div>

              <button type="button" class="btn btn-primary btn-vermas w-100 mt-2" data-id="{{ p.id }}">
                Ver Más
              </button>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

<!-- Script Efecto Drag e Drop -->
<script>
document.addEventListener("DOMContentLoaded", function () {

  const columns = document.querySelectorAll(".pedidos-board .kanban-column");

  function refreshEmptyColumns(){
    columns.forEach(col => {
      const hasCard = col.querySelector(".pedido-card"); 
      col.classList.toggle("is-empty", !hasCard);
    });
  }

  columns.forEach(column => {
    new Sortable(column, {
      group: "pedidos",
      animation: 150,
      ghostClass: "drag-over",

      onEnd: function (evt) {
        const card = evt.item;
        const newEstado = evt.to.id;     
        const pedidoId = card.dataset.id;

        fetch(`/pedidos/mover/${pedidoId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ estado: newEstado })
        })
        .then(res => {
          if (!res.ok) {
            evt.from.appendChild(card);
            alert("Error al mover el pedido");
          }
          refreshEmptyColumns();
        })
        .catch(() => {
          evt.from.appendChild(card);
          alert("Error al mover el pedido");
          refreshEmptyColumns();
        });
      }
    });
  });

  document.addEventListener("click", (e) => {

    const toggle = e.target.closest(".pedido-toggle");
    if (toggle) {
      e.preventDefault();
      e.stopPropagation();

      const card = toggle.closest(".pedido-nueva");
      const body = card.querySelector(".pedido-body");
      const isCollapsed = body.classList.contains("pedido-collapsed");

      if (isCollapsed) {
        body.classList.remove("pedido-collapsed");
        card.classList.add("is-open");
      } else {
        body.classList.add("pedido-collapsed");
        card.classList.remove("is-open");
      }
      return;
    }

    const btn = e.target.closest(".btn-vermas");
    if (btn) {
      e.preventDefault();
      e.stopPropagation();
      alert("Ver Más (Pedido #" + btn.dataset.id + ") — Popup lo hacemos después ✅");
    }
  });

  refreshEmptyColumns();
});
</script>
{% endblock %}