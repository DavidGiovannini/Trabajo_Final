{% extends "base.html" %}
{% block content %}
<h3 class="mb-3">Pedidos</h3>

<div class="pedidos-board">
  <hr class="mb-3">
  <div class="row g-4">
    <!-- PENDIENTES -->
    <div class="col-md-4">
      <h5 class="text-center mb-3">Pendientes</h5>
      <div class="kanban-column" id="PENDIENTE">
        {% for p in pedidos_pendientes %}
          {% set fecha_estado = '-' %}
          {% if p.estado == 'PENDIENTE' and p.pendiente_at %}
            {% set fecha_estado = p.pendiente_at.strftime('%d/%m/%Y') %}
          {% elif p.estado == 'EN_CURSO' and p.en_curso_at %}
            {% set fecha_estado = p.en_curso_at.strftime('%d/%m/%Y') %}
          {% elif p.estado == 'FINALIZADO' and p.finalizado_at %}
            {% set fecha_estado = p.finalizado_at.strftime('%d/%m/%Y') %}
          {% endif %}

          {% set deb = (p.total or 0) - (p.monto_sena or 0) %}
          {% set deb_clase = 'text-danger' if deb > 0 else 'text-success' %}

          <div class="pedido-card pedido-nueva" data-id="{{ p.id }}">
            <div class="pedido-header">
              <div class="pedido-title">{{ (p.cliente or '-')|upper }}</div>
              <div class="pedido-fecha">{{ fecha_estado }}</div>

              <button type="button" class="pedido-toggle" aria-label="Desplegar/ocultar">
                <i class="bi bi-chevron-down"></i>
              </button>
            </div>

            <div class="pedido-body pedido-collapsed">
              <div class="pedido-label">Pedido: <span class="text-muted">#{{ p.id }}</span></div>

              <div class="pedido-items">
                {% for it in p.items %}
                  <div class="pedido-item-line">{{ it.descripcion }}</div>
                {% else %}
                  <div class="pedido-item-line text-muted">Sin items</div>
                {% endfor %}
              </div>

              <div class="pedido-debe">
                <div class="pedido-debe-label">Debe:</div>
                <div class="pedido-debe-valor {{ deb_clase }}">
                  ${{ '%.2f'|format(deb) }}
                </div>
              </div>

              <button type="button" class="btn btn-primary btn-vermas w-100 mt-2" data-pedido-open="{{ p.id }}">
                Ver Más
              </button>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- EN CURSO -->
    <div class="col-md-4">
      <h5 class="text-center mb-3">En Curso</h5>
      <div class="kanban-column" id="EN_CURSO">
        {% for p in pedidos_en_curso %}
          {% set fecha_estado = '-' %}
          {% if p.estado == 'PENDIENTE' and p.pendiente_at %}
            {% set fecha_estado = p.pendiente_at.strftime('%d/%m/%Y') %}
          {% elif p.estado == 'EN_CURSO' and p.en_curso_at %}
            {% set fecha_estado = p.en_curso_at.strftime('%d/%m/%Y') %}
          {% elif p.estado == 'FINALIZADO' and p.finalizado_at %}
            {% set fecha_estado = p.finalizado_at.strftime('%d/%m/%Y') %}
          {% endif %}

          {% set deb = (p.total or 0) - (p.monto_sena or 0) %}
          {% set deb_clase = 'text-danger' if deb > 0 else 'text-success' %}

          <div class="pedido-card pedido-nueva" data-id="{{ p.id }}">
            <div class="pedido-header">
              <div class="pedido-title">{{ (p.cliente or '-')|upper }}</div>
              <div class="pedido-fecha">{{ fecha_estado }}</div>

              <button type="button" class="pedido-toggle" aria-label="Desplegar/ocultar">
                <i class="bi bi-chevron-down"></i>
              </button>
            </div>

            <div class="pedido-body pedido-collapsed">
              <div class="pedido-label">Pedido: <span class="text-muted">#{{ p.id }}</span></div>

              <div class="pedido-items">
                {% for it in p.items %}
                  <div class="pedido-item-line">{{ it.descripcion }}</div>
                {% else %}
                  <div class="pedido-item-line text-muted">Sin items</div>
                {% endfor %}
              </div>

              <div class="pedido-debe">
                <div class="pedido-debe-label">Debe:</div>
                <div class="pedido-debe-valor {{ deb_clase }}">
                  ${{ '%.2f'|format(deb) }}
                </div>
              </div>

              <button type="button" class="btn btn-primary btn-vermas w-100 mt-2" data-pedido-open="{{ p.id }}">
                Ver Más
              </button>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- FINALIZADOS -->
    <div class="col-md-4">
      <h5 class="text-center mb-3">Finalizados</h5>
      <div class="kanban-column" id="FINALIZADO">
        {% for p in pedidos_finalizados %}
          {% set fecha_estado = '-' %}
          {% if p.estado == 'PENDIENTE' and p.pendiente_at %}
            {% set fecha_estado = p.pendiente_at.strftime('%d/%m/%Y') %}
          {% elif p.estado == 'EN_CURSO' and p.en_curso_at %}
            {% set fecha_estado = p.en_curso_at.strftime('%d/%m/%Y') %}
          {% elif p.estado == 'FINALIZADO' and p.finalizado_at %}
            {% set fecha_estado = p.finalizado_at.strftime('%d/%m/%Y') %}
          {% endif %}

          {% set deb = (p.total or 0) - (p.monto_sena or 0) %}
          {% set deb_clase = 'text-danger' if deb > 0 else 'text-success' %}

          <div class="pedido-card pedido-nueva" data-id="{{ p.id }}">
            <div class="pedido-header">
              <div class="pedido-title">{{ (p.cliente or '-')|upper }}</div>
              <div class="pedido-fecha">{{ fecha_estado }}</div>

              <button type="button" class="pedido-toggle" aria-label="Desplegar/ocultar">
                <i class="bi bi-chevron-down"></i>
              </button>
            </div>

            <div class="pedido-body pedido-collapsed">
              <div class="pedido-label">Pedido: <span class="text-muted">#{{ p.id }}</span></div>

              <div class="pedido-items">
                {% for it in p.items %}
                  <div class="pedido-item-line">{{ it.descripcion }}</div>
                {% else %}
                  <div class="pedido-item-line text-muted">Sin items</div>
                {% endfor %}
              </div>

              <div class="pedido-debe">
                <div class="pedido-debe-label">Debe:</div>
                <div class="pedido-debe-valor {{ deb_clase }}">
                  ${{ '%.2f'|format(deb) }}
                </div>
              </div>

              <button type="button" class="btn btn-primary btn-vermas w-100 mt-2" data-pedido-open="{{ p.id }}">
                Ver Más
              </button>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const columns = document.querySelectorAll(".kanban-column");

  function refreshEmptyColumns(){
    columns.forEach(col => {
      const hasCard = !!col.querySelector(".pedido-nueva");
      col.classList.toggle("is-empty", !hasCard);
    });
  }

  refreshEmptyColumns();

  columns.forEach(col => {
    new Sortable(col, {
      group: "pedidos",
      animation: 150,
      draggable: ".pedido-nueva",
      handle: ".pedido-header",
      filter: "button, .btn, a, input, select, textarea",
      preventOnFilter: true,
      chosenClass: "sortable-chosen",
      dragClass: "sortable-drag",

      onEnd: async (evt) => {
        const card = evt.item;
        const pedidoId = card.dataset.id;
        const newEstado = evt.to.id;

        refreshEmptyColumns();
        if (evt.from === evt.to) return;

        try {
          const res = await fetch(`/pedidos/mover/${pedidoId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ estado: newEstado })
          });

          if (!res.ok) {
            evt.from.appendChild(card);
            refreshEmptyColumns();
            alert("Error al mover el pedido");
          }
        } catch (e) {
          evt.from.appendChild(card);
          refreshEmptyColumns();
          alert("Error al mover el pedido");
        }
      },

      onAdd: refreshEmptyColumns,
      onRemove: refreshEmptyColumns
    });
  });

  document.addEventListener("click", (e) => {
    if (e.target.closest("input, select, textarea, a, button")) return;

    const card = e.target.closest(".pedido-nueva");
    if (!card) return;

    const body = card.querySelector(".pedido-body");
    if (!body) return;

    body.classList.toggle("pedido-collapsed");
    card.classList.toggle("is-open");
  });
});
</script>

{% include "partials/pedido_modal.html" %}
{% endblock %}