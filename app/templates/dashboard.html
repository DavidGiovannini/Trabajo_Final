{% extends "base.html" %}
{% block content %}

<div class="row g-3 mb-3">

  <div class="col-lg-3 col-md-6 col-6">
    <div class="card shadow-sm kpi-card kpi-blanco">
      <div class="card-body">
        <div class="small">Pedidos totales</div>
        <div class="fs-3 fw-bold">{{ total_pedidos }}</div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 col-6">
    <div class="card shadow-sm kpi-card kpi-gris">
      <div class="card-body">
        <div class="small">Pendientes</div>
        <div class="fs-3 fw-bold">{{ pendientes }}</div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 col-6">
    <div class="card shadow-sm kpi-card kpi-naranja">
      <div class="card-body">
        <div class="small">En curso</div>
        <div class="fs-3 fw-bold">{{ en_curso }}</div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 col-6">
    <div class="card shadow-sm kpi-card kpi-azul">
      <div class="card-body">
        <div class="small">Finalizados</div>
        <div class="fs-3 fw-bold">{{ finalizados }}</div>
      </div>
    </div>
  </div>

</div>

<div class="charts-shell mb-1">
  <button class="charts-nav left" type="button" aria-label="Anterior">‹</button>

  <div class="charts-track">
    <!-- Dona -->
    <div class="charts-slide">
      <div class="card dashboard-card">
        <div class="card-body">
          <h6 class="mb-3">Distribución por Estado ($)</h6>
          <div class="chart-box">
            <canvas id="graficoDona"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Línea -->
    <div class="charts-slide">
      <div class="card dashboard-card">
        <div class="card-body">
          <h6 class="mb-3">Ventas últimos 7 días</h6>
          <div class="chart-box">
            <canvas id="graficoLinea"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Barras -->
    <div class="charts-slide">
      <div class="card dashboard-card">
        <div class="card-body">
          <h6 class="mb-3">Productos más vendidos</h6>
          <div class="chart-box">
            <canvas id="graficoBarras"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <button class="charts-nav right" type="button" aria-label="Siguiente">›</button>
</div>

<!-- Grilla del Dashboard -->
<div class="row g-3 mt-0">
  <div class="col-12">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="fw-semibold">Últimos pedidos</div>
          <button class="btn btn-secondary btn-sm"
            id="btnExpandirTabla"
            data-bs-toggle="modal"
            data-bs-target="#modalTablaExpandida">
            Ver Más
          </button>
        </div>

        <div class="table-responsive">
          <table class="table" id="tablaPedidos">
            <thead>
              <tr>
                <th>#</th><th>Cliente</th><th>Forma Pago</th><th>Seña</th><th>Teléfono</th><th>Estado</th><th>Total</th><th></th>
              </tr>
            </thead>
            <tbody>
              {% for p in ultimos %}
              <tr>
                <td>{{p.id}}</td>
                <td>{{p.cliente}}</td>
                <td>{{ p.forma_pago or "-" }}</td>
                <td>{{ "Sí" if p.tiene_sena else "No" }}</td>
                <td>{{p.telefono}}</td>
                <td>
                  {% if p.estado == "PENDIENTE" %}
                    <span class="badge bg-warning text-dark">Pendiente</span>
                  {% elif p.estado == "EN_CURSO" %}
                    <span class="badge bg-secondary">En Curso</span>
                  {% elif p.estado == "FINALIZADO" %}
                    <span class="badge bg-success">Finalizado</span>
                  {% endif %}
                </td>
                <td>${{"%.2f"|format(p.total)}}</td>
                <td>
                  <button 
                    class="btn btn-outline-primary btn-sm"
                    data-pedido-open="{{ p.id }}">
                    Ver Detalle
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Modal Tabla Expandida -->
<div class="modal fade" id="modalTablaExpandida" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Pedidos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <!-- Filtros -->
        <div class="d-flex gap-3 mb-3">
          <input type="text"
           id="buscarCliente"
           class="form-control"
           placeholder="Buscar por cliente...">
          <select id="filtroEstado" class="form-select w-auto">
            <option value="TODOS">Todos los estados</option>
            <option value="PENDIENTE">Pendiente</option>
            <option value="EN_CURSO">En curso</option>
            <option value="FINALIZADO">Finalizado</option>
          </select>
        </div>
        <!-- Tabla -->
        <div class="table-responsive">
          <table class="table table-striped" id="tablaPedidosModal">
            <thead>
              <tr>
                <th>#</th>
                <th>Cliente</th>
                <th>Forma Pago</th>
                <th>Seña</th>
                <th>Teléfono</th>
                <th>Estado</th>
                <th>Total</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
            {% for pedido in pedidos_modal %}
            <tr>
              <td>{{ pedido.id }}</td>
              <td>{{ pedido.cliente }}</td>
              <td>{{ pedido.forma_pago or "-" }}</td>
              <td>{% if pedido.monto_sena %}Sí{% else %}No{% endif %}</td>
              <td>{{ pedido.telefono }}</td>
              <td>
                {% if pedido.estado == "PENDIENTE" %}
                  <span class="badge bg-warning text-dark">Pendiente</span>
                {% elif pedido.estado == "EN_CURSO" %}
                  <span class="badge bg-secondary">En Curso</span>
                {% elif pedido.estado == "FINALIZADO" %}
                  <span class="badge bg-success">Finalizado</span>
                {% endif %}
              </td>
              <td>${{ "%.2f"|format(pedido.total) }}</td>
              <td>
                <button 
                  class="btn btn-outline-primary btn-sm"
                  data-pedido-open="{{ pedido.id }}">
                  Ver Detalle
                </button>
              </td>
            </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ====== DONA ======
const totalGeneral = {{ total_pendiente }} + {{ total_en_curso }} + {{ total_finalizado }};

const graficoDona = new Chart(document.getElementById("graficoDona"), {
  type: "doughnut",
  data: {
    labels: ["Pendientes", "En curso", "Finalizados"],
    datasets: [{
      data: [
        {{ total_pendiente }},
        {{ total_en_curso }},
        {{ total_finalizado }}
      ],
      backgroundColor: [
        "#4a4a4a",
        "#c46200",
        "#0b2a4a"
      ],
      borderWidth: 2
    }]
  },
  options: {
    cutout: "65%",
    plugins: {
      legend: { position: "bottom" },
      tooltip: {
        callbacks: {
          label: function(context) {
            const value = Number(context.raw || 0);
            const percentage = totalGeneral > 0
              ? ((value / totalGeneral) * 100).toFixed(1)
              : "0.0";
            return context.label + ": $" + value.toLocaleString() + " (" + percentage + "%)";
          }
        }
      }
    },
    animation: {
      animateRotate: true,
      animateScale: true,
      duration: 1200,
      easing: "easeOutQuart"
    },
    responsive: true,
    maintainAspectRatio: false
  },
  plugins: [{
    id: "centerText",
    beforeDraw(chart) {
      const { ctx, chartArea } = chart;

      const centerX = (chartArea.left + chartArea.right) / 2;
      const centerY = (chartArea.top + chartArea.bottom) / 2;

      ctx.save();
      ctx.font = "bold 22px sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillStyle = "#333";

      ctx.fillText("$" + Number(totalGeneral).toLocaleString(), centerX, centerY);
      ctx.restore();
    }
  }]
});

document.getElementById("graficoDona").addEventListener("click", function(evt) {
  const points = graficoDona.getElementsAtEventForMode(
    evt,
    "nearest",
    { intersect: true },
    true
  );

  if (!points.length) return;

  const index = points[0].index;
  const estado = ["PENDIENTE", "EN_CURSO", "FINALIZADO"][index];
  window.location.href = "/pedidos?estado=" + estado;
});

// ====== LÍNEA ======
new Chart(document.getElementById("graficoLinea"), {
  type: "line",
  data: {
    labels: {{ serie_labels | tojson }},
    datasets: [{
      label: "Total $",
      data: {{ serie_totales | tojson }},
      borderColor: "#0b2a4a",
      backgroundColor: "rgba(11,42,74,0.1)",
      tension: 0.3,
      fill: true
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false
  }
});

// ====== BARRAS ======
new Chart(document.getElementById("graficoBarras"), {
  type: "bar",
  data: {
    labels: {{ productos_labels | tojson }},
    datasets: [{
      label: "Cantidad",
      data: {{ productos_cantidades | tojson }},
      backgroundColor: "#c46200"
    }]
  },
  options: {
    indexAxis: "y",
    plugins: {
      legend: { display: false }
    },
    responsive: true,
    maintainAspectRatio: false
  }
});
</script>

<!-- Script Filtros Modal Pedidos -->
<script>
const buscarInput = document.getElementById("buscarCliente");
const estadoSelect = document.getElementById("filtroEstado");
const tablaBody = document.querySelector("#modalTablaExpandida tbody");

async function cargarPedidos() {

    const estado = estadoSelect.value;
    const cliente = buscarInput.value;

    const response = await fetch(`/api/pedidos?estado=${estado}&cliente=${cliente}`);
    const data = await response.json();

    tablaBody.innerHTML = "";

    data.pedidos.forEach(p => {

        let badge = "";

        if (p.estado === "PENDIENTE") {
            badge = `<span class="badge text-bg-warning text-dark">Pendiente</span>`;
        } else if (p.estado === "EN_CURSO") {
            badge = `<span class="badge text-bg-secondary">En curso</span>`;
        } else if (p.estado === "FINALIZADO") {
            badge = `<span class="badge text-bg-success">Finalizado</span>`;
        }

        tablaBody.innerHTML += `
            <tr>
                <td>${p.id}</td>
                <td>${p.cliente}</td>
                <td>${p.forma_pago}</td>
                <td>${p.sena}</td>
                <td>${p.telefono}</td>
                <td>${badge}</td>
                <td>$${p.total.toFixed(2)}</td>
                <td>
                    <button 
                        class="btn btn-outline-primary btn-sm"
                        data-pedido-open="${p.id}">
                      Ver Detalle
                    </button>
                </td>
            </tr>
        `;
    });
}

estadoSelect.addEventListener("change", cargarPedidos);

buscarInput.addEventListener("input", function() {
    clearTimeout(this.delay);
    this.delay = setTimeout(cargarPedidos, 300);
});

document.getElementById("modalTablaExpandida")
    .addEventListener("shown.bs.modal", cargarPedidos);
</script>

<!-- Carrusel graficos -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const shell = document.querySelector(".charts-shell");
  if (!shell) return;

  const track = shell.querySelector(".charts-track");
  const btnL  = shell.querySelector(".charts-nav.left");
  const btnR  = shell.querySelector(".charts-nav.right");

  function slideWidth() {
    const slide = track.querySelector(".charts-slide");
    if (!slide) return 520; 
    const gap = parseInt(getComputedStyle(track).gap || "16", 10);
    return slide.getBoundingClientRect().width + gap;
  }

  btnL?.addEventListener("click", () => {
    track.scrollBy({ left: -slideWidth(), behavior: "smooth" });
  });

  btnR?.addEventListener("click", () => {
    track.scrollBy({ left:  slideWidth(), behavior: "smooth" });
  });
});
</script>

{% include "partials/pedido_modal.html" %}
{% endblock %}