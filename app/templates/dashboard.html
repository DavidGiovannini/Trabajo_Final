{% extends "base.html" %}
{% block content %}

<div class="row g-3 mb-3">

  <div class="col-lg-3 col-md-6 col-6">
    <div class="card shadow-sm kpi-card kpi-blanco">
      <div class="card-body">
        <div class="small">Pedidos totales</div>
        <div class="fs-3 fw-bold">{{ total_pedidos }}</div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 col-6">
    <div class="card shadow-sm kpi-card kpi-gris">
      <div class="card-body">
        <div class="small">Pendientes</div>
        <div class="fs-3 fw-bold">{{ pendientes }}</div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 col-6">
    <div class="card shadow-sm kpi-card kpi-naranja">
      <div class="card-body">
        <div class="small">En curso</div>
        <div class="fs-3 fw-bold">{{ en_curso }}</div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 col-6">
    <div class="card shadow-sm kpi-card kpi-azul">
      <div class="card-body">
        <div class="small">Finalizados</div>
        <div class="fs-3 fw-bold">{{ finalizados }}</div>
      </div>
    </div>
  </div>

</div>

<div class="row g-3 mb-4">
  <!-- Dona -->
  <div class="col-lg-4 col-md-12">
    <div class="card dashboard-card">
      <div class="card-body">
        <h6 class="mb-3">Distribución por Estado ($)</h6>
        <canvas id="graficoDona"></canvas>
      </div>
    </div>
  </div>
  <!-- Línea -->
  <div class="col-lg-4 col-md-12">
    <div class="card dashboard-card">
      <div class="card-body">
        <h6 class="mb-3">Ventas últimos 7 días</h6>
        <canvas id="graficoLinea"></canvas>
      </div>
    </div>
  </div>
  <!-- Barras -->
  <div class="col-lg-4 col-md-12">
    <div class="card dashboard-card">
      <div class="card-body">
        <h6 class="mb-3">Productos más vendidos</h6>
        <canvas id="graficoBarras"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Grilla del Dashboard -->
<div class="row g-3 mt-1">
  <div class="col-12">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="fw-semibold">Últimos pedidos</div>
          <button class="btn btn-secondary btn-sm"
            id="btnExpandirTabla"
            data-bs-toggle="modal"
            data-bs-target="#modalPedidos">
            Ver Más
          </button>
        </div>
        <div class="table-responsive">
            <table class="table" id="tablaPedidos">
                <thead>
                <tr>
                    <th>#</th><th>Cliente</th><th>Forma Pago</th><th>Seña</th><th>Teléfono</th><th>Estado</th><th>Total</th><th></th>
                </tr>
                </thead>
                <tbody>
                {% for p in ultimos %}
                    <tr>
                    <td>{{p.id}}</td>
                    <td>{{p.cliente}}</td>
                    <td>{{ p.forma_pago or "-" }}</td>
                    <td>{{ "Sí" if p.tiene_sena else "No" }}</td>
                    <td>{{p.telefono}}</td>
                    <td>
                        {% if p.estado == "PENDIENTE" %}
                          <span class="badge bg-warning text-dark">Pendiente</span>
                        {% elif p.estado == "EN_CURSO" %}
                          <span class="badge bg-secondary">En Curso</span>
                        {% elif p.estado == "FINALIZADO" %}
                          <span class="badge bg-success">Finalizado</span>
                        {% endif %}
                    </td>
                    <td>${{"%.2f"|format(p.total)}}</td>
                    <td>
                        <button 
                            class="btn btn-outline-primary btn-sm btn-ver-detalle"
                            data-id="{{ p.id }}"
                            data-cliente="{{ p.cliente }}"
                            data-telefono="{{ p.telefono }}"
                            data-forma_pago="{{ p.forma_pago }}"
                            data-sena="{{ 'Sí' if p.tiene_sena else 'No' }}"
                            data-monto_sena="{{ p.monto_sena }}"
                            data-email="{{ p.email or '-' }}"
                            data-direccion="{{ p.direccion or '-' }}"
                            data-estado="{{ p.estado }}"
                            data-total="{{ p.total }}"
                            data-observaciones="{{ p.observaciones or '-' }}"
                            data-pendiente_at="{{ p.pendiente_at.strftime('%d/%m/%Y') if (p.estado=='PENDIENTE' and p.pendiente_at) else '-' }}"
                            data-en_curso_at="{{ p.en_curso_at.strftime('%d/%m/%Y') if (p.estado=='EN_CURSO' and p.en_curso_at) else '-' }}"
                            data-finalizado_at="{{ p.finalizado_at.strftime('%d/%m/%Y') if (p.estado=='FINALIZADO' and p.finalizado_at) else '-' }}"
                        >
                            Ver Detalle
                        </button>
                    </td>                 
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Tabla Expandida -->
<div class="modal fade" id="modalTablaExpandida" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Pedidos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <!-- Filtros -->
        <div class="d-flex gap-3 mb-3">
          <input type="text"
           id="buscarCliente"
           class="form-control"
           placeholder="Buscar por cliente...">
          <select id="filtroEstado" class="form-select w-auto">
            <option value="TODOS">Todos los estados</option>
            <option value="PENDIENTE">Pendiente</option>
            <option value="EN_CURSO">En curso</option>
            <option value="FINALIZADO">Finalizado</option>
          </select>
        </div>
        <!-- Tabla -->
        <div class="table-responsive">
          <table class="table table-striped" id="tablaPedidosModal">
            <thead>
              <tr>
                <th>#</th>
                <th>Cliente</th>
                <th>Forma Pago</th>
                <th>Seña</th>
                <th>Teléfono</th>
                <th>Estado</th>
                <th>Total</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
            {% for pedido in pedidos_modal %}
            <tr>
              <td>{{ pedido.id }}</td>
              <td>{{ pedido.cliente }}</td>
              <td>{{ pedido.forma_pago or "-" }}</td>
              <td>{% if pedido.monto_sena %}Sí{% else %}No{% endif %}</td>
              <td>{{ pedido.telefono }}</td>
              <td>
                {% if pedido.estado == "PENDIENTE" %}
                  <span class="badge bg-warning text-dark">Pendiente</span>
                {% elif pedido.estado == "EN_CURSO" %}
                  <span class="badge bg-secondary">En Curso</span>
                {% elif pedido.estado == "FINALIZADO" %}
                  <span class="badge bg-success">Finalizado</span>
                {% endif %}
              </td>
              <td>${{ "%.2f"|format(pedido.total) }}</td>
              <td>
                <button 
                  class="btn btn-outline-primary btn-sm btn-ver-detalle"
                  data-id="{{ pedido.id }}"
                  data-cliente="{{ pedido.cliente }}"
                  data-telefono="{{ pedido.telefono }}"
                  data-forma_pago="{{ pedido.forma_pago }}"
                  data-sena="{{ 'Sí' if pedido.tiene_sena else 'No' }}"
                  data-monto_sena="{{ pedido.monto_sena }}"
                  data-email="{{ pedido.email or '-' }}"
                  data-direccion="{{ pedido.direccion or '-' }}"  
                  data-estado="{{ pedido.estado }}"
                  data-total="{{ pedido.total }}"
                  data-observaciones="{{ pedido.observaciones or '-' }}"
                  data-pendiente_at="{{ pedido.pendiente_at.strftime('%d/%m/%Y') if (pedido.estado=='PENDIENTE' and pedido.pendiente_at) else '-' }}"
                  data-en_curso_at="{{ pedido.en_curso_at.strftime('%d/%m/%Y') if (pedido.estado=='EN_CURSO' and pedido.en_curso_at) else '-' }}"
                  data-finalizado_at="{{ pedido.finalizado_at.strftime('%d/%m/%Y') if (pedido.estado=='FINALIZADO' and pedido.finalizado_at) else '-' }}"
                  >
                  Ver Detalle
                </button>
              </td>
            </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Detalle Pedido -->
<div class="modal fade" id="modalDetalle" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detalle del Pedido</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>Cliente:</strong> <span id="det-cliente"></span></p>
        <p><strong>Teléfono:</strong> <span id="det-telefono"></span></p>
        <p><strong>Forma de Pago:</strong> <span id="det-forma-pago"></span></p>
        <p><strong>Seña:</strong> <span id="det-sena"></span></p>
        <p><strong>Monto Seña:</strong> $<span id="det-monto-sena"></span></p>
        <p><strong>E-Mail:</strong> <span id="det-email"></span></p>
        <p><strong>Dirección:</strong> <span id="det-direccion"></span></p>
        <p><strong>Estado:</strong> <span id="det-estado"></span></p>
        <p><strong>Total:</strong> $<span id="det-total"></span></p>
        <p><strong>Observaciones:</strong></p>
        <p><strong>Fecha Pendiente:</strong> <span id="det-pendiente-at"></span></p>
        <p><strong>Fecha En Curso:</strong> <span id="det-en-curso-at"></span></p>
        <p><strong>Fecha Finalizado:</strong> <span id="det-finalizado-at"></span></p>
        <p id="det-observaciones" class="text-muted"></p>
      </div>
    </div>
  </div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ====== DONA ======
const totalGeneral = {{ total_pendiente }} + {{ total_en_curso }} + {{ total_finalizado }};

new Chart(document.getElementById("graficoDona"), {
  type: "doughnut",
  data: {
    labels: ["Pendientes", "En curso", "Finalizados"],
    datasets: [{
      data: [
        {{ total_pendiente }},
        {{ total_en_curso }},
        {{ total_finalizado }}
      ],
      backgroundColor: [
        "#4a4a4a",   
        "#c46200",   
        "#0b2a4a"    
      ],
      borderWidth: 2
    }]
  },
  options: {
    cutout: "65%",
    plugins: {
      legend: { position: "bottom" },
      tooltip: {
        callbacks: {
          label: function(context) {
            const value = context.raw;
            const percentage = ((value / totalGeneral) * 100).toFixed(1);
            return context.label + ": $" + value.toLocaleString() + 
                    " (" + percentage + "%)";
          }
        }
      }
    },
    animation: {
    animateRotate: true,
    animateScale: true,
    duration: 1200,
    easing: 'easeOutQuart'
    },
    responsive: true,
    maintainAspectRatio: false
  },
  plugins: [{
    id: "centerText",
    beforeDraw(chart) {
      const { ctx, chartArea } = chart;

      const centerX = (chartArea.left + chartArea.right) / 2;
      const centerY = (chartArea.top + chartArea.bottom) / 2;

      ctx.save();
      ctx.font = "bold 22px sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillStyle = "#333";

      ctx.fillText(
        "$" + totalGeneral.toLocaleString(),
        centerX,
        centerY
      );
      ctx.restore();
    }
  }]
});
document.getElementById("graficoDona").onclick = function(evt) {
    const points = graficoDona.getElementsAtEventForMode(
        evt, 
        'nearest', 
        { intersect: true }, 
        true
    );

    if (points.length) {
        const index = points[0].index;
        const estado = ["PENDIENTE", "EN_CURSO", "FINALIZADO"][index];

        window.location.href = "/pedidos?estado=" + estado;
    }
};
// ====== LÍNEA ======
new Chart(document.getElementById("graficoLinea"), {
  type: "line",
  data: {
    labels: {{ serie_labels | tojson }},
    datasets: [{
      label: "Total $",
      data: {{ serie_totales | tojson }},
      borderColor: "#0b2a4a",
      backgroundColor: "rgba(11,42,74,0.1)",
      tension: 0.3,
      fill: true
    }]
},
  options: {
    responsive: true,
    maintainAspectRatio: false
  }
});
// ====== BARRAS ======
new Chart(document.getElementById("graficoBarras"), {
  type: "bar",
  data: {
    labels: {{ productos_labels | tojson }},
    datasets: [{
      label: "Cantidad",
      data: {{ productos_cantidades | tojson }},
      backgroundColor: "#c46200"
    }]
  },
  options: {
    indexAxis: "y",  
    plugins: {
      legend: { display: false }
    },
    responsive: true,
    maintainAspectRatio: false
  }
});
</script>

<!-- Modal Ver Detalle -->
<script>
document.querySelectorAll(".btn-ver-detalle").forEach(btn => {
  btn.addEventListener("click", function() {
    document.getElementById("det-cliente").textContent = this.dataset.cliente || "-";
    document.getElementById("det-telefono").textContent = this.dataset.telefono || "-";
    document.getElementById("det-forma-pago").textContent = this.dataset.forma_pago || "-";
    document.getElementById("det-sena").textContent = this.dataset.sena || "No";
    document.getElementById("det-monto-sena").textContent = this.dataset.monto_sena ? parseFloat(this.dataset.monto_sena).toFixed(2) : "-";
    document.getElementById("det-email").textContent = this.dataset.email || "-";
    document.getElementById("det-direccion").textContent = this.dataset.direccion || "-";
    document.getElementById("det-estado").textContent = this.dataset.estado || "-";
    document.getElementById("det-total").textContent = parseFloat(this.dataset.total).toFixed(2);
    document.getElementById("det-observaciones").textContent = this.dataset.observaciones || "-";
    document.getElementById("det-pendiente-at").textContent = this.dataset.pendiente_at || "-";
    document.getElementById("det-en-curso-at").textContent = this.dataset.en_curso_at || "-";
    document.getElementById("det-finalizado-at").textContent = this.dataset.finalizado_at || "-";

    const modal = new bootstrap.Modal(document.getElementById('modalDetalle'));
    modal.show();
  });
});
</script>

<!-- Botón Expandir -->
<script>
document.getElementById("btnExpandirTabla").addEventListener("click", function() {
  const modal = new bootstrap.Modal(document.getElementById("modalTablaExpandida"));
  modal.show();
});
</script>

<!-- Script Filtros Modal Pedidos -->
<script>
const buscarInput = document.getElementById("buscarCliente");
const estadoSelect = document.getElementById("filtroEstado");
const tablaBody = document.querySelector("#modalTablaExpandida tbody");

tablaBody.addEventListener("click", function(e) {

    const btn = e.target.closest(".btn-ver-detalle");
    if (!btn) return;

    document.getElementById("det-cliente").textContent = btn.dataset.cliente || "-";
    document.getElementById("det-telefono").textContent = btn.dataset.telefono || "-";
    document.getElementById("det-forma-pago").textContent = btn.dataset.forma_pago || "-";
    document.getElementById("det-sena").textContent = btn.dataset.sena || "No";
    document.getElementById("det-monto-sena").textContent = btn.dataset.monto_sena ? parseFloat(btn.dataset.monto_sena).toFixed(2) : "-";
    document.getElementById("det-email").textContent = btn.dataset.email || "-";
    document.getElementById("det-direccion").textContent = btn.dataset.direccion || "-";
    document.getElementById("det-estado").textContent = btn.dataset.estado || "-";
    document.getElementById("det-total").textContent = btn.dataset.total ? parseFloat(btn.dataset.total).toFixed(2) : "0.00";
    document.getElementById("det-observaciones").textContent = btn.dataset.observaciones || "-";
    document.getElementById("det-pendiente-at").textContent = btn.dataset.pendiente_at || "-";
    document.getElementById("det-en-curso-at").textContent = btn.dataset.en_curso_at || "-";
    document.getElementById("det-finalizado-at").textContent = btn.dataset.finalizado_at || "-";

    const modal = new bootstrap.Modal(document.getElementById("modalDetalle"));
    modal.show();
});

async function cargarPedidos() {

    const estado = estadoSelect.value;
    const cliente = buscarInput.value;

    const response = await fetch(`/api/pedidos?estado=${estado}&cliente=${cliente}`);
    const data = await response.json();

    tablaBody.innerHTML = "";

    data.pedidos.forEach(p => {

        let badge = "";

        if (p.estado === "PENDIENTE") {
            badge = `<span class="badge text-bg-warning text-dark">Pendiente</span>`;
        } else if (p.estado === "EN_CURSO") {
            badge = `<span class="badge text-bg-secondary">En curso</span>`;
        } else if (p.estado === "FINALIZADO") {
            badge = `<span class="badge text-bg-success">Finalizado</span>`;
        }

        tablaBody.innerHTML += `
            <tr>
                <td>${p.id}</td>
                <td>${p.cliente}</td>
                <td>${p.forma_pago}</td>
                <td>${p.sena}</td>
                <td>${p.telefono}</td>
                <td>${badge}</td>
                <td>$${p.total.toFixed(2)}</td>
                <td>
                    <button 
                        class="btn btn-outline-primary btn-sm btn-ver-detalle"
                        data-id="${p.id}"
                        data-cliente="${p.cliente}"
                        data-telefono="${p.telefono}"
                        data-forma_pago="${p.forma_pago}"
                        data-sena="${p.sena}"
                        data-estado="${p.estado}"
                        data-total="${p.total}"
                        data-pendiente_at="${p.pendiente_at}"
                        data-en_curso_at="${p.en_curso_at}"
                        data-finalizado_at="${p.finalizado_at}"
                    >
                        Ver Detalle
                    </button>
                </td>
            </tr>
        `;
    });
}

// Eventos
estadoSelect.addEventListener("change", cargarPedidos);

buscarInput.addEventListener("input", function() {
    clearTimeout(this.delay);
    this.delay = setTimeout(cargarPedidos, 300);
});

// Cargar cuando abre el modal
document.getElementById("modalTablaExpandida")
    .addEventListener("shown.bs.modal", cargarPedidos);
</script>
{% endblock %}
